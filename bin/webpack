#!/usr/bin/env ruby
$stdout.sync = true

require 'shellwords'
require 'yaml'

ENV['RAILS_ENV'] ||= 'development'
RAILS_ENV = ENV['RAILS_ENV']

ENV['NODE_ENV'] ||= RAILS_ENV
NODE_ENV = ENV['NODE_ENV']

APP_PATH          = File.expand_path('../', __dir__)
NODE_MODULES_PATH = File.join(APP_PATH, 'node_modules')
WEBPACK_CONFIG    = File.join(APP_PATH, "config/webpack/#{NODE_ENV}.js")

unless File.exist?(WEBPACK_CONFIG)
  puts 'Webpack configuration not found.'
  exit!
end

newenv  = { 'NODE_PATH' => NODE_MODULES_PATH.shellescape }

cmd = %w[yarn run webpack]
cmd << '--config' << WEBPACK_CONFIG

Dir.chdir(APP_PATH) do
  exec newenv, *cmd, *ARGV
end
